/*
Copyright 2025 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
syntax = "proto3";

package workloadagent.protos.openshiftmetrics;

import "google/protobuf/timestamp.proto";

option java_outer_classname = "OpenshiftMetricsPayload";
option java_multiple_files = true;
option go_package = "github.com/GoogleCloudPlatform/workloadagent/protos/openshiftmetrics";

// OpenshiftMetricsPayload is the payload for the Openshift WLM metrics.
message OpenshiftMetricsPayload {
  // The version of the metric payload.
  string version = 1;
  // The version of the agent that generated the metric payload.
  string agent_version = 2;
  // The ID of the Openshift cluster.
  string cluster_id = 3;
  // The project ID that the workload agent is running in.
  string project_id = 4;
  // The namespaces in the Openshift cluster.
  ResourceListContainer namespaces = 5;
  // The CSI drivers in the Openshift cluster.
  ResourceListContainer csi_drivers = 6;
  // The cluster CSI drivers in the Openshiftcluster.
  ResourceListContainer cluster_csi_drivers = 7;
  // The storage classes in the Openshift cluster.
  ResourceListContainer storage_classes = 8;
  // The persistent volume claims in the Openshift cluster.
  ResourceListContainer persistent_volume_claims = 9;
  // The config maps in the Openshift cluster.
  ResourceListContainer config_maps = 10;
  // The deployments in the Openshift cluster.
  ResourceListContainer deployments = 11;
  // The custom resource definitions in the cluster.
  ResourceListContainer custom_resource_definitions = 12;
}

// General container for K8 resources.
message ResourceListContainer {
  // The K8 resource identifier.
  string kind = 1;
  // The K8 resource api version.
  string api_version = 2;
  // The K8 resource metadata.
  Metadata metadata = 3;
  // The items that are in the container.
  oneof container_items {
    NamespaceList namespaces = 4;
    CsiDriverList csi_drivers = 5;
    ClusterCsiDriverList cluster_csi_drivers = 6;
    StorageClassList storage_classes = 7;
    PersistentVolumeClaimList persistent_volume_claims = 8;
    ConfigMapList config_maps = 9;
    DeploymentList deployments = 10;
    CustomResourceDefinitionList custom_resource_definitions = 11;
  }
  // The K8 resource metadata.
  message Metadata {
    string resource_version = 1;
  }
}

// Equivalent to k8s.io/apimachinery/pkg/apis/meta/v1/ObjectMeta
message ResourceMetadata {
  // The K8 resource name that is unique within the namespace.
  string name = 1;
  // The K8 resource uid.
  string uid = 2;
  // ID of the owning namespace of the resource. If the resource is cluster
  // scoped, this will be empty.
  string namespace = 3;
  // The K8 resource version.
  string resource_version = 4;
  // The K8 resource generation.
  int64 generation = 5;
  // The K8 resource creation timestamp.
  google.protobuf.Timestamp creation_timestamp = 6;
  // K8 labels are identifiers for the resource.
  map<string, string> labels = 7;
  // Non-identifying metadata about the resource.
  map<string, string> annotations = 8;
}

// Container for K8/OCP namespaces.
message NamespaceList {
  repeated Namespace items = 1;
}

// Message describing a K8/OCP namespace.
message Namespace {
  ResourceMetadata metadata = 1;
}

// Container for K8/OCP CSI drivers.
message CsiDriverList {
  repeated CsiDriver items = 1;
}

// Message describing a K8/OCP CSI driver.
message CsiDriver {
  ResourceMetadata metadata = 1;
  Spec spec = 2;

  message Spec {
    bool attach_required = 1;
    bool pod_info_on_mount = 2;
    repeated string volume_lifecycle_modes = 3;
    bool storage_capacity = 4;
    string fs_group_policy = 5;
    bool requires_republish = 6;
    bool se_linux_mount = 7;
  }
}

// Container for K8/OCP cluster CSI drivers.
message ClusterCsiDriverList {
  repeated ClusterCsiDriver items = 1;
}

// Message describing a K8/OCP cluster CSI driver.
message ClusterCsiDriver {
  ResourceMetadata metadata = 1;
  Spec spec = 2;
  Status status = 3;

  message Spec {
    DriverConfig driver_config = 1;
    string log_level = 2;
    string management_state = 3;
    string operator_log_level = 4;
  }

  message DriverConfig {
    string driver_type = 1;
  }

  message Status {
    repeated Conditions conditions = 1;
  }

  message Conditions {
    google.protobuf.Timestamp last_transition_time = 1;
    string status = 2;
    string type = 3;
  }
}

// Container for K8/OCP storage classes.
message StorageClassList {
  repeated StorageClass items = 1;
}

// Message describing a K8/OCP storage class.
message StorageClass {
  ResourceMetadata metadata = 1;
  string provisioner = 2;
  Parameters parameters = 3;
  string reclaim_policy = 4;
  bool allow_volume_expansion = 5;
  string volume_binding_mode = 6;

  message Parameters {
    string replication_type = 1;
    string type = 2;
    // The KMS key used for disk encryption.
    // Format:
    // projects/PROJECT_ID/locations/LOCATION/keyRings/KEY_RING/cryptoKeys/KEY_NAME
    string disk_encryption_kms_key = 3;
    // Comma separated list of storage pools.
    // Format: projects/PROJECT_ID/zones/ZONE/storagePools/STORAGE_POOL_NAME
    string storage_pools = 4;
  }
}

// Container for K8/OCP persistent volume claims.
message PersistentVolumeClaimList {
  repeated PersistentVolumeClaim items = 1;
}

// Equivalent to k8s.io/api/core/v1/types.PersistentVolumeClaim
message PersistentVolumeClaim {
  ResourceMetadata metadata = 1;
  Spec spec = 2;
  Status status = 3;

  message Spec {
    repeated string access_modes = 1;
    Resources resources = 2;
    string volume_name = 3;
    string storage_class_name = 4;
    string volume_mode = 5;
  }

  message Resources {
    Requests requests = 1;
  }

  message Requests {
    string storage = 1;
  }

  message Status {
    string phase = 1;
    repeated string access_modes = 2;
    Capacity capacity = 3;
  }

  message Capacity {
    string storage = 1;
  }
}

message ConfigMapList {
  repeated ConfigMap items = 1;
}

// Derived from
// https://kubernetes.io/docs/reference/kubernetes-api/config-and-storage-resources/config-map-v1/#ConfigMap
message ConfigMap {
  ResourceMetadata metadata = 1;
  map<string, string> data = 2;
}

message CustomResourceDefinitionList {
  repeated CustomResourceDefinition items = 1;
}

// Derived from
// https://kubernetes.io/docs/reference/kubernetes-api/extend-resources/custom-resource-definition-v1/#CustomResourceDefinition
message CustomResourceDefinition {
  ResourceMetadata metadata = 1;
}

message DeploymentList {
  repeated Deployment items = 1;
}

// Derived from
// https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/deployment-v1/#Deployment
message Deployment {
  ResourceMetadata metadata = 1;
  Spec spec = 2;

  message Spec {
    PodTemplateSpec pod_template = 1;

    message PodTemplateSpec {
      ResourceMetadata metadata = 1;
      PodSpec spec = 2;
    }
  }
}

// Derived from
// https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podspec-v1-core
message PodSpec {
  repeated Container containers = 1;
  repeated Container init_containers = 2;
  repeated Volume volumes = 3;
}

// Derived from
// https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#container-v1-core
message Container {
  repeated Env env = 1;
  repeated EnvFrom env_from = 2;
}

// Derived from
// https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#volume-v1-core
message Volume {
  Secret secret = 1;
  message Secret {
    string secret_name = 1;
  }
}

// Derived from
// https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#envvar-v1-core
message Env {
  ValueFrom value_from = 1;
  message ValueFrom {
    SecretKeyRef secret_key_ref = 1;
    message SecretKeyRef {
      string name = 1;
    }
  }
}

// Derived from
// https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#envfromsource-v1-core
message EnvFrom {
  SecretRef secret_ref = 1;
  message SecretRef {
    string name = 1;
  }
}
